<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LCAMP Configurator</title>
    <link rel="stylesheet" href="LCAMP_Order.css">
</head>
<body>
    <div class="container">
        <h2>Nachricht an LCAMP Configurator senden</h2>

        <label for="sender">Absender</label>
        <select id="sender">
            <option value="DHBW">DHBW</option>
            <option value="TKnika">TKnika</option>
            <option value="CNG">CNG</option>
        </select>

        <label for="command">Command</label>
        <select id="command">
            <option value="Start">Start</option>
            <option value="Stop">Stop</option>
            <option value="Restart">Restart</option>
            <option value="Status">Status</option>
            <option value="Load">Load</option>
            <option value="Save">Save</option>
            <option value="Generate_Partlist">Generate Partlist</option>
            <option value="Generate_URDF">Generate URDF</option>
            <option disabled>──────────</option>
            <option value="GetSensorTemplate">GetSensorTemplate</option>
            <option value="GetDriveTemplate">GetDriveTemplate</option>

        </select>

        <label for="content">Nachricht</label>
        <textarea id="content" placeholder="Hier den Inhalt eingeben..."></textarea>

        <!-- Command-Button direkt nach Nachricht -->
        <button class="btn-full" onclick="sendCommand()">Command senden</button>

        <!-- Unterformular für Achskonfiguration -->
        <div class="subform">
            <h3>Achskonfiguration</h3>
            <div class="grid-container">
                <div>
                    <label for="frontDrives">Vorderachse-Antrieb</label>
                    <select id="frontDrives">
                        <option value="DC-Drive">DC-Drive</option>
                        <option value="Stepper-Drive">Stepper-Drive</option>
                        <option value="Drive-Holder">Drive-Holder</option>
                    </select>
                </div>

                <div>
                    <label for="rearDrives">Hinterachse-Antrieb</label>
                    <select id="rearDrives">
                        <option value="DC-Drive">DC-Drive</option>
                        <option value="Stepper-Drive">Stepper-Drive</option>
                        <option value="Drive-Holder">Drive-Holder</option>
                    </select>
                </div>

                <div>
                    <label for="frontWheels">Vorderachse-Räder</label>
                    <select id="frontWheels">
                        <option value="Regular-Wheel">Regular-Wheel</option>
                        <option value="Omni-Wheel">Omni-Wheel</option>
                        <option value="Mecanum-Wheel">Mecanum-Wheel</option>
                    </select>
                </div>

                <div>
                    <label for="rearWheels">Hinterachse-Räder</label>
                    <select id="rearWheels">
                        <option value="Regular-Wheel">Regular-Wheel</option>
                        <option value="Omni-Wheel">Omni-Wheel</option>
                        <option value="Mecanum-Wheel">Mecanum-Wheel</option>
                    </select>
                </div>
            </div>

            <label>Antriebsart</label>
            <div class="radio-group">
                <label><input type="radio" name="driveType" value="Differential" checked> Differential Drive</label>
                <label><input type="radio" name="driveType" value="Omni"> Omni Drive</label>
            </div>
        </div>

        <!-- Zwei Buttons -->
        <div class="btn-row">
            <button onclick="sendConfiguration()">Achskonfiguration senden</button>
        </div>

        <!-- Tabelle für sensorform -->
        <div class="sensorform">
            <h3>Sensor-Konfiguration</h3>

            <!-- Tab Buttons -->
            <div class="btn-row">
                <button class="tab-btn active" onclick="showSensorTab(0)">Sensorbox Front</button>
                <button class="tab-btn" onclick="showSensorTab(1)">Sensorbox Rear</button>
                <button class="tab-btn" onclick="showSensorTab(2)">Sensorbox Center</button>
                <button class="tab-btn" onclick="showSensorTab(3)">Sensorbox Controller</button>



                <script>
                    // --- Utility: load JSON from local data.json if present ---
                    async function tryLoadDataJson() {
                        try {
                            const res = await fetch('data.json', { cache: 'no-store' });
                            if (!res.ok) throw new Error('no data.json');
                            const json = await res.json();
                            return json;
                        } catch (e) {
                            return null;
                        }
                    }

                    // --- State persistence (expanded paths) ---
                    const LS_KEY = 'json-tree-expanded-v1';
                    let expanded = new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]'));
                    function saveExpanded() {
                        localStorage.setItem(LS_KEY, JSON.stringify([...expanded]));
                    }

                    // --- Rendering ---
                    const treeEl = document.getElementById('tree');
                    const statsEl = document.getElementById('stats');

                    function isObject(x) { return Object.prototype.toString.call(x) === '[object Object]'; }

                    function summarize(value) {
                        if (value === null) return 'null';
                        if (Array.isArray(value)) return `Array(${value.length})`;
                        if (isObject(value)) return 'Object';
                        if (typeof value === 'string') return JSON.stringify(value.length > 32 ? value.slice(0, 32) + '…' : value);
                        return String(value);
                    }

                    function pathJoin(base, key) {
                        return base ? base + '.' + key : String(key);
                    }

                    function createNode({ key, value, path }) {
                        const isLeaf = !(isObject(value) || Array.isArray(value));
                        const li = document.createElement('li');
                        li.className = `node ${isLeaf ? 'leaf' : ''}`;
                        li.setAttribute('role', 'treeitem');
                        li.setAttribute('aria-expanded', String(expanded.has(path)));

                        const toggle = document.createElement('span');
                        toggle.className = 'toggle';
                        li.appendChild(toggle);

                        const label = document.createElement('span');
                        label.className = 'label';
                        const keySpan = document.createElement('span');
                        keySpan.className = 'key';
                        keySpan.textContent = key !== undefined ? (value?.name || String(key)) : '(root)';
                        label.appendChild(keySpan);

                        const type = document.createElement('span');
                        type.className = 'type';
                        const badge = document.createElement('span');
                        badge.textContent = ' – ' + summarize(value);
                        type.appendChild(badge);
                        label.appendChild(type);

                        li.appendChild(label);

                        if (!isLeaf) {
                            const childrenWrap = document.createElement('ul');
                            childrenWrap.className = 'children';
                            childrenWrap.setAttribute('role', 'group');

                            const items = Array.isArray(value)
                                ? value.map((v, i) => ({ k: i, v }))
                                : Object.keys(value).sort().map(k => ({ k, v: value[k] }));

                            for (const { k, v } of items) {
                                childrenWrap.appendChild(createNode({ key: k, value: v, path: pathJoin(path, k) }));
                            }
                            li.appendChild(childrenWrap);
                        }

                        // Expanded / collapsed state
                        const isExpanded = expanded.has(path) || path === '';
                        li.classList.toggle('expanded', isExpanded);
                        li.classList.toggle('collapsed', !isExpanded);

                        return li;
                    }

                    function render(root) {
                        treeEl.innerHTML = '';
                        const rootNode = createNode({ key: 'root', value: root, path: '' });
                        treeEl.appendChild(rootNode);
                        updateStats(root);
                    }

                    function updateStats(data) {
                        let nodes = 0, leaves = 0;
                        (function walk(v) {
                            nodes++;
                            if (!(isObject(v) || Array.isArray(v))) { leaves++; return; }
                            const items = Array.isArray(v) ? v : Object.values(v);
                            for (const c of items) walk(c);
                        })(data);
                        statsEl.textContent = `${nodes.toLocaleString('de-DE')} Knoten · ${leaves.toLocaleString('de-DE')} Blätter`;
                    }

                    // --- Interactions ---
                    treeEl.addEventListener('click', (e) => {
                        const li = e.target.closest('li.node');
                        if (!li) return;
                        const onToggle = e.target.classList.contains('toggle');
                        if (!onToggle) return;

                        const path = getPathForNode(li);
                        li.classList.toggle('expanded');
                        li.classList.toggle('collapsed');
                        const isExp = li.classList.contains('expanded');
                        li.setAttribute('aria-expanded', String(isExp));
                        if (isExp) expanded.add(path); else expanded.delete(path);
                        saveExpanded();
                    });

                    function getPathForNode(li) {
                        // Build path from labels by walking up (labels are unique per level)
                        const pathParts = [];
                        let cur = li;
                        while (cur && cur !== treeEl) {
                            const label = cur.querySelector(':scope > .label .key');
                            if (label) pathParts.push(label.textContent);
                            cur = cur.parentElement.closest('li.node');
                        }
                        pathParts.pop(); // remove 'root'
                        return pathParts.reverse().join('.');
                    }

                    // Expand/Collapse all
                    document.getElementById('expandAll').addEventListener('click', () => {
                        document.querySelectorAll('#tree .node').forEach(li => li.classList.add('expanded'));
                        document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('collapsed'));
                        // naive: mark all paths expanded
                        expanded = new Set(['']);
                        document.querySelectorAll('#tree .node .label .key').forEach(k => {
                            const parts = [];
                            let el = k.closest('li.node');
                            while (el && el !== treeEl) {
                                const kk = el.querySelector(':scope > .label .key').textContent;
                                parts.push(kk);
                                el = el.parentElement.closest('li.node');
                            }
                            parts.pop();
                            const p = parts.reverse().join('.');
                            expanded.add(p);
                        });
                        saveExpanded();
                    });

                    document.getElementById('collapseAll').addEventListener('click', () => {
                        document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('expanded'));
                        document.querySelectorAll('#tree .node').forEach(li => li.classList.add('collapsed'));
                        expanded = new Set();
                        saveExpanded();
                    });

                    // Toggle types visibility
                    let showTypes = true;
                    document.getElementById('toggleTypes').addEventListener('click', () => {
                        showTypes = !showTypes;
                        document.querySelectorAll('.type').forEach(el => el.style.display = showTypes ? '' : 'none');
                    });

                    // Search / filter highlight
                    const searchInput = document.getElementById('search');
                    const clearBtn = document.getElementById('clearSearch');
                    clearBtn.addEventListener('click', () => { searchInput.value = ''; applySearch(''); });
                    searchInput.addEventListener('input', (e) => applySearch(e.target.value));

                    function applySearch(q) {
                        q = (q || '').trim().toLowerCase();
                        document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('match'));
                        if (!q) return;
                        document.querySelectorAll('#tree .node').forEach(li => {
                            const key = li.querySelector(':scope > .label .key')?.textContent?.toLowerCase() || '';
                            const typeTxt = li.querySelector(':scope > .label .type')?.textContent?.toLowerCase() || '';
                            if (key.includes(q) || typeTxt.includes(q)) {
                                li.classList.add('match');
                                // expand parents to reveal
                                let p = li.parentElement.closest('li.node');
                                while (p) { p.classList.add('expanded'); p.classList.remove('collapsed'); p = p.parentElement.closest('li.node'); }
                            }
                        });
                    }

                    // File input (local JSON)
                    document.getElementById('fileInput').addEventListener('change', async (e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        const text = await file.text();
                        const json = JSON.parse(text);
                        expanded = new Set(['']); saveExpanded();
                        render(json);
                    });

                    // Sample data
                    const SAMPLE = {
                        app: { name: "Baumviewer", version: "1.0.0", features: ["expand", "collapse", "search"] },
                        server: { host: "localhost", port: 7070, tls: false },
                        users: [
                            { id: 1, name: "Anna", roles: ["admin", "editor"], active: true },
                            { id: 2, name: "Ben", roles: ["viewer"], active: false }
                        ],
                        meta: { updated: "2025-08-21", tags: ["json", "tree", "viewer"] }
                    };

                    document.getElementById('loadSample').addEventListener('click', () => {
                        expanded = new Set(['']); saveExpanded();
                        render(SAMPLE);
                    });

                    // Boot: try load data.json else sample
                    (async function init() {
                        const data = await tryLoadDataJson();
                        render(data ?? SAMPLE);
                    })();
                </script>

            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Front -->
                <div id="frontSensors" class="tab-panel">
                    <h4>Sensorbox Front</h4>
                    <label>Sensor 1:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 2:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 3:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 4:</label><select><option>SensorA</option><option>SensorB</option></select>
                </div>

                <!-- Rear -->
                <div id="rearSensors" class="tab-panel hidden">
                    <h4>Sensorbox Rear</h4>
                    <label>Sensor 1:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 2:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 3:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 4:</label><select><option>SensorA</option><option>SensorB</option></select>
                </div>

                <!-- Center -->
                <div id="centerSensors" class="tab-panel hidden">
                    <h4>Sensorbox Center</h4>
                    <label>Sensor 1:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 2:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 3:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 4:</label><select><option>SensorA</option><option>SensorB</option></select>
                </div>

                <!-- Controller -->
                <div id="controllerSensors" class="tab-panel hidden">
                    <h4>Sensorbox Controller</h4>
                    <label>Sensor 1:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 2:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 3:</label><select><option>SensorA</option><option>SensorB</option></select>
                    <label>Sensor 4:</label><select><option>SensorA</option><option>SensorB</option></select>
                </div>
            </div>
        </div>

        <!-- Zwei Buttons -->
        <div class="btn-row">
            <button onclick="sendSensors()">Sensor-Konfiguration senden</button>
        </div>

        <div class="tree-wrap">
            <ul id="tree" class="tree" role="tree"></ul>
        </div>

        <pre id="serverReply" style="background:#eee; padding:10px; border-radius:6px;"></pre>

        <!-- Abschitt für response -->
        <div class="response" id="reply"><strong>Antwort:</strong></div>
    </div>

    <!-- Abschitt Scripte -->
    <script>
        function showSensorTab(index) {
            const panels = document.querySelectorAll('.tab-panel');
            const buttons = document.querySelectorAll('.tab-btn');

            panels.forEach((panel, i) => {
                if (i === index) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            buttons.forEach((btn, i) => btn.classList.toggle('active', i === index));
        }
        function collectSensors(containerId) {
            const selects = document.querySelectorAll(`#${containerId} select`);
            return Array.from(selects).map(sel => sel.value);
        }
        async function sendSensors() {
            const sensorData = {
                front: collectSensors("frontSensors"),
                rear: collectSensors("rearSensors"),
                center: collectSensors("centerSensors"),
                controller: collectSensors("controllerSensors")
            };

            const msg = {
                sender: document.getElementById('sender')?.value || "WebUI",
                command: "SetSensors",
                content: document.getElementById('contend')?.value || "",
                type: "setSensors",
                sensorConfiguration: sensorData
            };

            const res = await fetch("http://localhost:5000/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(msg)
            });

            const reply = await res.json();
            alert("Antwort vom Server:\n" + JSON.stringify(reply, null, 2));
        }
    </script>

    <script>
        async function sendCommand() {
            const msg = {
                sender: document.getElementById('sender').value,
                command: document.getElementById('command').value,
                content: document.getElementById('content').value,
                type: "sendCommand"
            };
            await sendToServer(msg);
        }

        async function sendConfiguration() {
            const msg = {
                sender: document.getElementById('sender').value,
                command: document.getElementById('command').value,
                content: document.getElementById('content').value,
                type: "setAxis",
                axisConfiguration: {
                    frontDrives: document.getElementById('frontDrives').value,
                    rearDrives: document.getElementById('rearDrives').value,
                    frontWheels: document.getElementById('frontWheels').value,
                    rearWheels: document.getElementById('rearWheels').value,
                    driveType: document.querySelector('input[name="driveType"]:checked').value
                }
            };
            await sendToServer(msg);
        }

        async function sendToServer(msg) {
            try {
                const res = await fetch('http://localhost:5000/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(msg)
                });
                const json = await res.json();
                document.getElementById('reply').textContent = JSON.stringify(json, null, 2);
            } catch (err) {
                document.getElementById('reply').textContent = "Fehler beim Senden: " + err;
            }
        }
    </script>

    <script>
        async function requestServer(msg) {
            try {
                const res = await fetch('http://localhost:5000/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(msg)
                });
                if (!res.ok) {
                    throw new Error("HTTP-Fehler " + res.status);
                }
                const data = await res.json();
                console.log("Antwort vom Server:", data);
                return data;
            } catch (err) {
                console.error("Fehler bei Serverabfrage:", err);
                return null;
            }
        }

        // beim Laden der Seite ausführen
        window.addEventListener('DOMContentLoaded', async () => {
            const msg = {
                sender: "BrowserClient",
                command: "GetSensorTemplate",
                content: "frontSensors",
                type: "Request"
            };
            const reply = await requestServer(msg);

            if (reply) {
                // Hier kannst du das Ergebnis in deine Seite einbauen
                document.getElementById("serverReply").textContent = JSON.stringify(reply, null, 2);
            }
        });
        const sensorOptionsJson = { "options": ["...", "Lidar","UltraSonic","LED-Light","Temp"] };

        function populateSelects(containerId, options) {
            const selects = document.querySelectorAll(`#${containerId} select`);
            selects.forEach(select => {
                select.innerHTML = "";
                options.forEach(opt => {
                    const optionElement = document.createElement("option");
                    optionElement.value = opt;
                    optionElement.textContent = opt;
                    select.appendChild(optionElement);
                });
            });
        }

        // Beispiel: Center-Sensoren befüllen
        populateSelects("frontSensors", sensorOptionsJson.options);
        populateSelects("rearSensors", sensorOptionsJson.options);
        populateSelects("centerSensors", sensorOptionsJson.options);
        populateSelects("controllerSensors", sensorOptionsJson.options);
    </script>
</body>
</html>