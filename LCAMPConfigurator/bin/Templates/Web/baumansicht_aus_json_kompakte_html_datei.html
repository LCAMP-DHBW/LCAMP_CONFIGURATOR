<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Baumansicht – kompakt & übersichtlich</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --muted: #64748b;       /* slate-500 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #93c5fd;      /* blue-300 */
      --node: #cbd5e1;        /* slate-300 */
      --border: #1f2937;      /* gray-800 */
      --focus: #2563eb;       /* blue-600 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
        Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    header {
      position: sticky; top: 0; z-index: 5;
      display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;
      padding: .6rem .8rem; background: rgba(17, 24, 39, .9); backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
    }

    header h1 { font-size: 1rem; margin: 0 .5rem 0 0; color: var(--node); font-weight: 600; }

    .btn {
      appearance: none; border: 1px solid var(--border); background: #0b1221; color: var(--text);
      padding: .35rem .6rem; border-radius: .6rem; cursor: pointer; font-size: .9rem;
    }
    .btn:hover { border-color: #334155; }
    .btn:focus { outline: 2px solid var(--focus); outline-offset: 2px; }

    .toolbar { display: flex; gap: .4rem; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1 1 auto; }

    .search { display: inline-flex; align-items: center; gap: .4rem; }
    .search input {
      background: #0b1221; color: var(--text); border: 1px solid var(--border);
      padding: .38rem .6rem; border-radius: .6rem; min-width: 14rem;
    }

    .tree-wrap {
      overflow: auto; height: 100%;
      padding: .6rem .6rem 1.2rem; 
    }

    /* Tree */
    ul.tree { list-style: none; padding-left: .6rem; margin: 0; }
    .node { position: relative; margin: 0; padding-left: 1.2rem; }

    .toggle {
      position: absolute; left: 0; top: .1rem; width: 1rem; height: 1rem;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: .9rem; color: var(--muted); cursor: pointer; user-select: none;
    }
    .toggle::before { content: '\25B6'; /* ▶ */ transition: transform .15s ease; }
    .expanded > .toggle::before { transform: rotate(90deg); }
    .leaf > .toggle { visibility: hidden; }

    .label {
      display: inline-block; padding: .05rem .25rem; border-radius: .4rem; 
      line-height: 1.35; white-space: nowrap; max-width: 100%; overflow: hidden; text-overflow: ellipsis;
    }
    .key { color: var(--accent); }
    .type { color: var(--muted); font-size: .85em; margin-left: .25rem; }
    .value { color: var(--node); }

    .children { margin-top: .15rem; margin-left: .6rem; border-left: 1px dashed #233044; padding-left: .6rem; }
    .collapsed > .children { display: none; }

    .match .label { background: rgba(37, 99, 235, .18); }

    /* Badges */
    .badge { font-size: .75em; color: var(--muted); border: 1px solid var(--border); padding: .05rem .35rem; border-radius: 999px; margin-left: .4rem; }

    /* Footer help */
    footer { color: var(--muted); font-size: .85rem; padding: .4rem .8rem; border-top: 1px solid var(--border); }
    kbd { border: 1px solid var(--border); background: #0b1221; padding: 0 .35rem; border-radius: .35rem; }
  </style>
</head>
<body>
  <header>
    <h1>JSON Baumansicht</h1>
    <div class="toolbar">
      <button class="btn" id="expandAll">Alle aufklappen</button>
      <button class="btn" id="collapseAll">Alle zuklappen</button>
      <button class="btn" id="toggleTypes">Typen anzeigen/ausblenden</button>
      <span class="badge" id="stats"></span>
    </div>
    <div class="spacer"></div>
    <div class="toolbar">
      <div class="search">
        <input id="search" type="search" placeholder="Suchen in Keys/Values… (Strg/⌘+F)" />
        <button class="btn" id="clearSearch">X</button>
      </div>
      <input class="btn" type="file" id="fileInput" accept="application/json,.json" />
      <button class="btn" id="loadSample">Beispiel laden</button>
    </div>
  </header>

  <div class="tree-wrap">
    <ul id="tree" class="tree" role="tree"></ul>
  </div>

  <footer>
    Tipp: Du kannst eine <kbd>data.json</kbd> neben diese Datei legen. Beim Öffnen wird sie automatisch geladen. |
    Navigation: Klick auf Pfeile zum Auf-/Zuklappen. Filter hebt Übereinstimmungen hervor.
  </footer>

  <script>
    // --- Utility: load JSON from local data.json if present ---
    async function tryLoadDataJson() {
      try {
        const res = await fetch('data.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('no data.json');
        const json = await res.json();
        return json;
      } catch (e) {
        return null;
      }
    }

    // --- State persistence (expanded paths) ---
    const LS_KEY = 'json-tree-expanded-v1';
    let expanded = new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]'));
    function saveExpanded() {
      localStorage.setItem(LS_KEY, JSON.stringify([...expanded]));
    }

    // --- Rendering ---
    const treeEl = document.getElementById('tree');
    const statsEl = document.getElementById('stats');

    function isObject(x){ return Object.prototype.toString.call(x) === '[object Object]'; }

    function summarize(value) {
      if (value === null) return 'null';
      if (Array.isArray(value)) return `Array(${value.length})`;
      if (isObject(value)) return 'Object';
      if (typeof value === 'string') return JSON.stringify(value.length > 32 ? value.slice(0,32) + '…' : value);
      return String(value);
    }

    function pathJoin(base, key) {
      return base ? base + '.' + key : String(key);
    }

    function createNode({key, value, path}) {
      const isLeaf = !(isObject(value) || Array.isArray(value));
      const li = document.createElement('li');
      li.className = `node ${isLeaf ? 'leaf' : ''}`;
      li.setAttribute('role', 'treeitem');
      li.setAttribute('aria-expanded', String(expanded.has(path)));

      const toggle = document.createElement('span');
      toggle.className = 'toggle';
      li.appendChild(toggle);

      const label = document.createElement('span');
      label.className = 'label';
      const keySpan = document.createElement('span');
      keySpan.className = 'key';
      keySpan.textContent = key !== undefined ? String(key) : '(root)';
      label.appendChild(keySpan);

      const type = document.createElement('span');
      type.className = 'type';
      const badge = document.createElement('span');
      badge.textContent = ' – ' + summarize(value);
      type.appendChild(badge);
      label.appendChild(type);

      li.appendChild(label);

      if (!isLeaf) {
        const childrenWrap = document.createElement('ul');
        childrenWrap.className = 'children';
        childrenWrap.setAttribute('role', 'group');

        const items = Array.isArray(value)
          ? value.map((v, i) => ({ k: i, v }))
          : Object.keys(value).sort().map(k => ({ k, v: value[k] }));

        for (const {k, v} of items) {
          childrenWrap.appendChild(createNode({ key: k, value: v, path: pathJoin(path, k) }));
        }
        li.appendChild(childrenWrap);
      }

      // Expanded / collapsed state
      const isExpanded = expanded.has(path) || path === '';
      li.classList.toggle('expanded', isExpanded);
      li.classList.toggle('collapsed', !isExpanded);

      return li;
    }

    function render(root) {
      treeEl.innerHTML = '';
      const rootNode = createNode({ key: 'root', value: root, path: '' });
      treeEl.appendChild(rootNode);
      updateStats(root);
    }

    function updateStats(data) {
      let nodes = 0, leaves = 0;
      (function walk(v){
        nodes++;
        if (!(isObject(v) || Array.isArray(v))) { leaves++; return; }
        const items = Array.isArray(v) ? v : Object.values(v);
        for (const c of items) walk(c);
      })(data);
      statsEl.textContent = `${nodes.toLocaleString('de-DE')} Knoten · ${leaves.toLocaleString('de-DE')} Blätter`;
    }

    // --- Interactions ---
    treeEl.addEventListener('click', (e) => {
      const li = e.target.closest('li.node');
      if (!li) return;
      const onToggle = e.target.classList.contains('toggle');
      if (!onToggle) return;

      const path = getPathForNode(li);
      li.classList.toggle('expanded');
      li.classList.toggle('collapsed');
      const isExp = li.classList.contains('expanded');
      li.setAttribute('aria-expanded', String(isExp));
      if (isExp) expanded.add(path); else expanded.delete(path);
      saveExpanded();
    });

    function getPathForNode(li) {
      // Build path from labels by walking up (labels are unique per level)
      const pathParts = [];
      let cur = li;
      while (cur && cur !== treeEl) {
        const label = cur.querySelector(':scope > .label .key');
        if (label) pathParts.push(label.textContent);
        cur = cur.parentElement.closest('li.node');
      }
      pathParts.pop(); // remove 'root'
      return pathParts.reverse().join('.');
    }

    // Expand/Collapse all
    document.getElementById('expandAll').addEventListener('click', () => {
      document.querySelectorAll('#tree .node').forEach(li => li.classList.add('expanded'));
      document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('collapsed'));
      // naive: mark all paths expanded
      expanded = new Set(['']);
      document.querySelectorAll('#tree .node .label .key').forEach(k => {
        const parts = [];
        let el = k.closest('li.node');
        while (el && el !== treeEl) {
          const kk = el.querySelector(':scope > .label .key').textContent;
          parts.push(kk);
          el = el.parentElement.closest('li.node');
        }
        parts.pop();
        const p = parts.reverse().join('.');
        expanded.add(p);
      });
      saveExpanded();
    });

    document.getElementById('collapseAll').addEventListener('click', () => {
      document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('expanded'));
      document.querySelectorAll('#tree .node').forEach(li => li.classList.add('collapsed'));
      expanded = new Set();
      saveExpanded();
    });

    // Toggle types visibility
    let showTypes = true;
    document.getElementById('toggleTypes').addEventListener('click', () => {
      showTypes = !showTypes;
      document.querySelectorAll('.type').forEach(el => el.style.display = showTypes ? '' : 'none');
    });

    // Search / filter highlight
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');
    clearBtn.addEventListener('click', () => { searchInput.value = ''; applySearch(''); });
    searchInput.addEventListener('input', (e) => applySearch(e.target.value));

    function applySearch(q) {
      q = (q || '').trim().toLowerCase();
      document.querySelectorAll('#tree .node').forEach(li => li.classList.remove('match'));
      if (!q) return;
      document.querySelectorAll('#tree .node').forEach(li => {
        const key = li.querySelector(':scope > .label .key')?.textContent?.toLowerCase() || '';
        const typeTxt = li.querySelector(':scope > .label .type')?.textContent?.toLowerCase() || '';
        if (key.includes(q) || typeTxt.includes(q)) {
          li.classList.add('match');
          // expand parents to reveal
          let p = li.parentElement.closest('li.node');
          while (p) { p.classList.add('expanded'); p.classList.remove('collapsed'); p = p.parentElement.closest('li.node'); }
        }
      });
    }

    // File input (local JSON)
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const json = JSON.parse(text);
      expanded = new Set(['']); saveExpanded();
      render(json);
    });

    // Sample data
    const SAMPLE = {
      app: { name: "Baumviewer", version: "1.0.0", features: ["expand", "collapse", "search"] },
      server: { host: "localhost", port: 7070, tls: false },
      users: [
        { id: 1, name: "Anna", roles: ["admin", "editor"], active: true },
        { id: 2, name: "Ben", roles: ["viewer"], active: false }
      ],
      meta: { updated: "2025-08-21", tags: ["json", "tree", "viewer"] }
    };

    document.getElementById('loadSample').addEventListener('click', () => {
      expanded = new Set(['']); saveExpanded();
      render(SAMPLE);
    });

    // Boot: try load data.json else sample
    (async function init(){
      const data = await tryLoadDataJson();
      render(data ?? SAMPLE);
    })();
  </script>
</body>
</html>
